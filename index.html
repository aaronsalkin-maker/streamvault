<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StreamVault</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c27;
  --border: rgba(255,255,255,0.07);
  --accent: #e8462a;
  --accent2: #ff7c5c;
  --gold: #f0c040;
  --text: #e8e8f0;
  --muted: #6b6b80;
  --radius: 10px;
  --font-display: 'Bebas Neue', sans-serif;
  --font-body: 'DM Sans', sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-body);overflow-x:hidden}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:3px}

/* â”€â”€ Login â”€â”€ */
#login-screen {
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background: radial-gradient(ellipse at 60% 40%, #1a0a0a 0%, #0a0a0f 70%);
  z-index:100;
}
.login-box {
  width:380px;padding:48px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(232,70,42,0.1);
  animation: fadeUp 0.5s ease;
}
.login-logo {
  font-family:var(--font-display);font-size:38px;letter-spacing:3px;
  color:var(--accent);text-align:center;margin-bottom:6px;
}
.login-sub {
  text-align:center;color:var(--muted);font-size:13px;letter-spacing:1px;
  text-transform:uppercase;margin-bottom:40px;
}
.field-label {
  font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);
  display:block;margin-bottom:8px;
}
.field-input {
  width:100%;padding:12px 16px;
  background:var(--bg);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:var(--font-body);font-size:14px;
  transition:border-color 0.2s;outline:none;
}
.field-input:focus{border-color:var(--accent)}
.field-group{margin-bottom:20px}
.btn-primary {
  width:100%;padding:14px;
  background:var(--accent);border:none;border-radius:8px;
  color:#fff;font-family:var(--font-body);font-size:14px;font-weight:500;
  letter-spacing:0.5px;cursor:pointer;
  transition:background 0.2s,transform 0.1s;
}
.btn-primary:hover{background:var(--accent2)}
.btn-primary:active{transform:scale(0.98)}
.error-msg{color:#ff6b6b;font-size:13px;text-align:center;margin-top:12px;min-height:18px}

/* â”€â”€ App Shell â”€â”€ */
#app{display:none;height:100vh;flex-direction:column}
#app.visible{display:flex}

/* â”€â”€ Topbar â”€â”€ */
.topbar {
  display:flex;align-items:center;gap:24px;padding:0 24px;height:60px;
  background:rgba(10,10,15,0.95);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;
  flex-shrink:0;
}
.topbar-logo{font-family:var(--font-display);font-size:24px;letter-spacing:2px;color:var(--accent);flex-shrink:0}
.topbar-search {
  flex:1;max-width:400px;position:relative;
}
.topbar-search input {
  width:100%;padding:8px 16px 8px 38px;
  background:var(--surface);border:1px solid var(--border);border-radius:20px;
  color:var(--text);font-family:var(--font-body);font-size:13px;outline:none;
  transition:border-color 0.2s;
}
.topbar-search input:focus{border-color:var(--accent)}
.search-icon {
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  color:var(--muted);font-size:14px;pointer-events:none;
}
.topbar-actions{margin-left:auto;display:flex;align-items:center;gap:12px}
.topbar-user {
  display:flex;align-items:center;gap:8px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:20px;padding:5px 14px 5px 8px;cursor:pointer;font-size:13px;
}
.avatar {
  width:26px;height:26px;border-radius:50%;
  background:var(--accent);display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:600;color:#fff;flex-shrink:0;
}
.btn-logout {
  background:none;border:1px solid var(--border);border-radius:8px;
  color:var(--muted);font-size:12px;cursor:pointer;padding:6px 12px;
  transition:all 0.2s;font-family:var(--font-body);
}
.btn-logout:hover{border-color:var(--accent);color:var(--accent)}

/* â”€â”€ Layout â”€â”€ */
.app-body{display:flex;flex:1;overflow:hidden}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar {
  width:220px;flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;padding:20px 0;
}
.sidebar-section {
  padding:0 16px;margin-bottom:8px;
  font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);
}
.nav-item {
  display:flex;align-items:center;gap:10px;
  padding:10px 20px;font-size:14px;color:var(--muted);
  cursor:pointer;transition:all 0.15s;border-left:3px solid transparent;
  user-select:none;
}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,0.03)}
.nav-item.active{color:var(--text);border-left-color:var(--accent);background:rgba(232,70,42,0.07)}
.nav-icon{width:16px;text-align:center;flex-shrink:0}

.sidebar-libraries{padding:8px 0}
.lib-item {
  display:flex;align-items:center;gap:8px;
  padding:8px 20px;font-size:13px;color:var(--muted);
  cursor:pointer;transition:all 0.15s;
}
.lib-item:hover{color:var(--text)}
.lib-item.active{color:var(--text)}
.lib-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);flex-shrink:0}
.lib-count{margin-left:auto;font-size:11px;background:var(--surface2);border-radius:10px;padding:1px 7px}

/* â”€â”€ Main Content â”€â”€ */
.main{flex:1;overflow-y:auto;padding:28px 32px}

/* â”€â”€ Views â”€â”€ */
.view{display:none;animation:fadeUp 0.3s ease}
.view.active{display:block}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ Section Headers â”€â”€ */
.section-header {
  display:flex;align-items:baseline;gap:12px;margin-bottom:20px;
}
.section-title {
  font-family:var(--font-display);font-size:28px;letter-spacing:1px;color:var(--text);
}
.section-count{color:var(--muted);font-size:13px}
.section-actions{margin-left:auto;display:flex;gap:8px}

/* â”€â”€ Cards â”€â”€ */
.media-grid {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
  gap:18px;
}
.media-card {
  border-radius:var(--radius);overflow:hidden;
  background:var(--surface);border:1px solid var(--border);
  cursor:pointer;transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s;
  position:relative;
}
.media-card:hover{
  transform:translateY(-4px);
  box-shadow:0 16px 40px rgba(0,0,0,0.5);
  border-color:rgba(232,70,42,0.3);
}
.card-thumb {
  aspect-ratio:16/10;background:var(--surface2);position:relative;overflow:hidden;
}
.card-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.card-thumb-placeholder {
  width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  font-size:32px;color:var(--muted);
}
.card-progress {
  position:absolute;bottom:0;left:0;height:3px;background:var(--accent);
  transition:width 0.3s;
}
.card-badge {
  position:absolute;top:8px;right:8px;
  background:rgba(0,0,0,0.8);border-radius:4px;
  padding:2px 6px;font-size:10px;color:var(--gold);
}
.card-body{padding:10px 12px}
.card-title{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-meta{font-size:11px;color:var(--muted);margin-top:3px}
.card-play-btn {
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.5);opacity:0;transition:opacity 0.2s;
}
.media-card:hover .card-play-btn{opacity:1}
.play-circle {
  width:44px;height:44px;border-radius:50%;
  background:var(--accent);display:flex;align-items:center;justify-content:center;
  font-size:16px;color:#fff;transition:transform 0.2s;
}
.media-card:hover .play-circle{transform:scale(1.1)}

/* â”€â”€ Continue Watching Row â”€â”€ */
.continue-row {
  display:flex;gap:14px;overflow-x:auto;padding-bottom:4px;
  scrollbar-width:none;
}
.continue-row::-webkit-scrollbar{display:none}
.continue-card {
  flex-shrink:0;width:220px;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;cursor:pointer;transition:transform 0.2s;
}
.continue-card:hover{transform:translateY(-3px)}
.continue-thumb{aspect-ratio:16/9;background:var(--surface2);position:relative;overflow:hidden}
.continue-thumb img{width:100%;height:100%;object-fit:cover}
.continue-prog{position:absolute;bottom:0;left:0;height:3px;background:var(--accent)}
.continue-body{padding:8px 10px}
.continue-title{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.continue-time{font-size:11px;color:var(--muted);margin-top:2px}

/* â”€â”€ Player â”€â”€ */
#player-overlay {
  display:none;position:fixed;inset:0;background:#000;z-index:200;
  flex-direction:column;
}
#player-overlay.visible{display:flex}
.player-top {
  display:flex;align-items:center;gap:12px;padding:14px 20px;
  background:linear-gradient(#000a,transparent);position:absolute;top:0;left:0;right:0;z-index:10;
}
.player-back {
  background:none;border:none;color:#fff;cursor:pointer;font-size:20px;padding:6px;
  border-radius:6px;transition:background 0.15s;
}
.player-back:hover{background:rgba(255,255,255,0.1)}
.player-title{color:#fff;font-size:15px;font-weight:500}
#video-el{width:100%;height:100%;background:#000}
.player-controls {
  position:absolute;bottom:0;left:0;right:0;
  padding:40px 24px 24px;
  background:linear-gradient(transparent,rgba(0,0,0,0.85));
}
.seek-bar-wrap{width:100%;cursor:pointer;padding:6px 0;margin-bottom:10px}
.seek-bar {
  width:100%;height:4px;background:rgba(255,255,255,0.2);
  border-radius:2px;position:relative;transition:height 0.15s;
}
.seek-bar-wrap:hover .seek-bar{height:6px}
.seek-fill{height:100%;background:var(--accent);border-radius:2px;pointer-events:none;transition:width 0.1s}
.seek-thumb {
  position:absolute;right:-6px;top:50%;transform:translateY(-50%);
  width:12px;height:12px;border-radius:50%;background:#fff;
  opacity:0;transition:opacity 0.15s;pointer-events:none;
}
.seek-bar-wrap:hover .seek-thumb{opacity:1}
.controls-row {
  display:flex;align-items:center;gap:16px;color:#fff;
}
.ctrl-btn {
  background:none;border:none;color:#fff;cursor:pointer;
  font-size:18px;padding:6px;border-radius:6px;transition:background 0.15s;
}
.ctrl-btn:hover{background:rgba(255,255,255,0.15)}
.ctrl-btn.primary{font-size:24px}
.time-display{font-size:13px;color:rgba(255,255,255,0.7);font-variant-numeric:tabular-nums}
.volume-wrap{display:flex;align-items:center;gap:8px}
.volume-slider{width:80px;cursor:pointer;accent-color:var(--accent)}
.quality-select {
  margin-left:auto;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
  color:#fff;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;
  font-family:var(--font-body);outline:none;
}
.fullscreen-btn{font-size:16px}

/* â”€â”€ Admin Panel â”€â”€ */
.admin-card {
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:24px;margin-bottom:20px;
}
.admin-card h3{font-size:16px;font-weight:500;margin-bottom:16px}
.form-row{display:flex;gap:12px;flex-wrap:wrap}
.form-field{flex:1;min-width:160px}
.form-field label{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:6px}
.form-field input, .form-field select {
  width:100%;padding:9px 12px;
  background:var(--bg);border:1px solid var(--border);border-radius:7px;
  color:var(--text);font-family:var(--font-body);font-size:13px;outline:none;
  transition:border-color 0.2s;
}
.form-field input:focus, .form-field select:focus{border-color:var(--accent)}
.btn-sm {
  padding:9px 18px;background:var(--accent);border:none;border-radius:7px;
  color:#fff;font-family:var(--font-body);font-size:13px;cursor:pointer;
  transition:background 0.2s;flex-shrink:0;align-self:flex-end;
}
.btn-sm:hover{background:var(--accent2)}
.btn-sm.ghost {
  background:none;border:1px solid var(--border);color:var(--muted);
}
.btn-sm.ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm.danger{background:#c0392b}
.btn-sm.danger:hover{background:#e74c3c}
.libs-table{width:100%;border-collapse:collapse}
.libs-table th{text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);padding:8px 12px;border-bottom:1px solid var(--border)}
.libs-table td{padding:12px;border-bottom:1px solid var(--border);font-size:13px}
.libs-table tr:last-child td{border-bottom:none}
.badge {
  display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;
}
.badge.video{background:rgba(232,70,42,0.15);color:var(--accent)}
.badge.audio{background:rgba(100,160,255,0.15);color:#64a0ff}
.badge.photo{background:rgba(100,220,100,0.15);color:#64dc64}

/* â”€â”€ Toast â”€â”€ */
.toast {
  position:fixed;bottom:24px;right:24px;z-index:999;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:12px 20px;font-size:13px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
  display:none;animation:slideIn 0.3s ease;
}
.toast.visible{display:block}
@keyframes slideIn{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}

/* â”€â”€ Empty State â”€â”€ */
.empty{text-align:center;padding:80px 20px;color:var(--muted)}
.empty-icon{font-size:48px;margin-bottom:16px;opacity:0.4}
.empty-text{font-size:15px;margin-bottom:8px}
.empty-sub{font-size:13px;opacity:0.6}

/* â”€â”€ Loading â”€â”€ */
.spinner {
  width:32px;height:32px;border:3px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;
  animation:spin 0.7s linear infinite;
  margin:60px auto;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:768px){
  .sidebar{display:none}
  .main{padding:16px}
  .media-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">StreamVault</div>
    <div class="login-sub">Your Personal Media Universe</div>
    <div class="field-group">
      <label class="field-label">Username</label>
      <input class="field-input" id="login-user" type="text" placeholder="admin" autocomplete="username"/>
    </div>
    <div class="field-group">
      <label class="field-label">Password</label>
      <input class="field-input" id="login-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
    </div>
    <button class="btn-primary" id="login-btn">Sign In</button>
    <div class="error-msg" id="login-err"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-logo">StreamVault</div>
    <div class="topbar-search">
      <span class="search-icon">âŒ•</span>
      <input type="text" id="search-input" placeholder="Search titlesâ€¦"/>
    </div>
    <div class="topbar-actions">
      <div class="topbar-user">
        <div class="avatar" id="user-avatar">?</div>
        <span id="user-name">â€¦</span>
      </div>
      <button class="btn-logout" id="logout-btn">Sign Out</button>
    </div>
  </header>

  <div class="app-body">
    <!-- SIDEBAR -->
    <nav class="sidebar">
      <div class="sidebar-section">Navigate</div>
      <div class="nav-item active" data-view="home">
        <span class="nav-icon">âŒ‚</span> Home
      </div>
      <div class="nav-item" data-view="movies">
        <span class="nav-icon">â–¶</span> Videos
      </div>
      <div class="nav-item" data-view="music">
        <span class="nav-icon">â™ª</span> Music
      </div>
      <div class="nav-item" data-view="photos">
        <span class="nav-icon">â—»</span> Photos
      </div>
      <div class="nav-item" data-view="history">
        <span class="nav-icon">â—·</span> History
      </div>
      <div class="nav-item" data-view="playlists">
        <span class="nav-icon">â‰¡</span> Playlists
      </div>

      <div class="sidebar-section" style="margin-top:20px">Libraries</div>
      <div class="sidebar-libraries" id="sidebar-libs"></div>

      <div style="margin-top:auto;padding-top:16px">
        <div class="nav-item" data-view="admin" id="admin-nav" style="display:none">
          <span class="nav-icon">âš™</span> Admin
        </div>
      </div>
    </nav>

    <!-- MAIN -->
    <main class="main">

      <!-- HOME VIEW -->
      <div class="view active" id="view-home">
        <div class="section-header">
          <span class="section-title">Continue Watching</span>
        </div>
        <div class="continue-row" id="continue-row">
          <div class="empty"><div class="empty-sub">Nothing in progress yet</div></div>
        </div>

        <div class="section-header" style="margin-top:36px">
          <span class="section-title">Recently Added</span>
        </div>
        <div class="media-grid" id="recent-grid"></div>
      </div>

      <!-- VIDEOS VIEW -->
      <div class="view" id="view-movies">
        <div class="section-header">
          <span class="section-title">Videos</span>
          <span class="section-count" id="video-count"></span>
        </div>
        <div class="media-grid" id="video-grid"></div>
      </div>

      <!-- MUSIC VIEW -->
      <div class="view" id="view-music">
        <div class="section-header">
          <span class="section-title">Music</span>
          <span class="section-count" id="audio-count"></span>
        </div>
        <div class="media-grid" id="audio-grid"></div>
      </div>

      <!-- PHOTOS VIEW -->
      <div class="view" id="view-photos">
        <div class="section-header">
          <span class="section-title">Photos</span>
          <span class="section-count" id="photo-count"></span>
        </div>
        <div class="media-grid" id="photo-grid"></div>
      </div>

      <!-- HISTORY VIEW -->
      <div class="view" id="view-history">
        <div class="section-header"><span class="section-title">Watch History</span></div>
        <div class="media-grid" id="history-grid"></div>
      </div>

      <!-- PLAYLISTS VIEW -->
      <div class="view" id="view-playlists">
        <div class="section-header">
          <span class="section-title">Playlists</span>
          <div class="section-actions">
            <input id="new-playlist-name" class="field-input" style="width:160px;padding:6px 12px;font-size:13px" placeholder="New playlistâ€¦"/>
            <button class="btn-sm" onclick="createPlaylist()">+ Create</button>
          </div>
        </div>
        <div id="playlists-container"></div>
      </div>

      <!-- ADMIN VIEW -->
      <div class="view" id="view-admin">
        <div class="section-header"><span class="section-title">Administration</span></div>

        <div class="admin-card">
          <h3>Add Library</h3>
          <div class="form-row">
            <div class="form-field">
              <label>Library Name</label>
              <input id="lib-name" type="text" placeholder="My Movies"/>
            </div>
            <div class="form-field">
              <label>Folder Path</label>
              <input id="lib-path" type="text" placeholder="/home/user/Videos"/>
            </div>
            <div class="form-field" style="max-width:130px">
              <label>Type</label>
              <select id="lib-type">
                <option value="video">Video</option>
                <option value="audio">Audio</option>
                <option value="photo">Photo</option>
              </select>
            </div>
            <button class="btn-sm" onclick="addLibrary()" style="align-self:flex-end">Add</button>
          </div>
        </div>

        <div class="admin-card">
          <h3>Libraries</h3>
          <table class="libs-table">
            <thead><tr>
              <th>Name</th><th>Path</th><th>Type</th><th>Items</th><th>Actions</th>
            </tr></thead>
            <tbody id="libs-tbody"></tbody>
          </table>
        </div>

        <div class="admin-card">
          <h3>Create User</h3>
          <div class="form-row">
            <div class="form-field">
              <label>Username</label>
              <input id="new-username" type="text"/>
            </div>
            <div class="form-field">
              <label>Password</label>
              <input id="new-password" type="password"/>
            </div>
            <button class="btn-sm" onclick="createUser()" style="align-self:flex-end">Create</button>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- PLAYER OVERLAY -->
<div id="player-overlay">
  <div class="player-top">
    <button class="player-back" id="player-close">â† Back</button>
    <span class="player-title" id="player-title"></span>
  </div>
  <video id="video-el" preload="metadata"></video>
  <div class="player-controls" id="player-controls">
    <div class="seek-bar-wrap" id="seek-wrap">
      <div class="seek-bar" id="seek-bar">
        <div class="seek-fill" id="seek-fill" style="width:0%"></div>
        <div class="seek-thumb" id="seek-thumb"></div>
      </div>
    </div>
    <div class="controls-row">
      <button class="ctrl-btn" id="skip-back-btn" title="âˆ’10s">âŸ¨âŸ¨</button>
      <button class="ctrl-btn primary" id="play-pause-btn">â–¶</button>
      <button class="ctrl-btn" id="skip-fwd-btn" title="+10s">âŸ©âŸ©</button>
      <div class="time-display" id="time-display">0:00 / 0:00</div>
      <div class="volume-wrap">
        <span>ğŸ”Š</span>
        <input type="range" class="volume-slider" id="vol-slider" min="0" max="1" step="0.05" value="1"/>
      </div>
      <select class="quality-select" id="quality-select">
        <option value="direct">Direct</option>
        <option value="1080p">1080p</option>
        <option value="720p" selected>720p</option>
        <option value="480p">480p</option>
      </select>
      <button class="ctrl-btn fullscreen-btn" id="fullscreen-btn">â›¶</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '';
let token = localStorage.getItem('sv_token');
let currentUser = null;
let currentMediaId = null;
let progressTimer = null;
let controlsTimeout = null;
let libraries = [];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Utilities
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API + path, { ...opts, headers: { ...headers, ...opts.headers } });
  if (res.status === 401) { logout(); return null; }
  return res.ok ? res.json() : null;
}

function toast(msg, duration = 3000) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('visible');
  setTimeout(() => el.classList.remove('visible'), duration);
}

function fmtTime(sec) {
  if (!sec || isNaN(sec)) return '0:00';
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = Math.floor(sec % 60);
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

function fmtSize(bytes) {
  if (!bytes) return '';
  if (bytes > 1e9) return (bytes/1e9).toFixed(1) + ' GB';
  if (bytes > 1e6) return (bytes/1e6).toFixed(1) + ' MB';
  return (bytes/1e3).toFixed(0) + ' KB';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Auth
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('login-btn').addEventListener('click', doLogin);
document.getElementById('login-pass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
document.getElementById('logout-btn').addEventListener('click', logout);

async function doLogin() {
  const u = document.getElementById('login-user').value;
  const p = document.getElementById('login-pass').value;
  document.getElementById('login-err').textContent = '';

  const form = new URLSearchParams({ username: u, password: p });
  try {
    const res = await fetch(API + '/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: form
    });
    if (!res.ok) {
      const err = await res.json();
      document.getElementById('login-err').textContent = err.detail || 'Login failed';
      return;
    }
    const data = await res.json();
    token = data.access_token;
    localStorage.setItem('sv_token', token);
    currentUser = { username: data.username, is_admin: data.is_admin };
    showApp();
  } catch(e) {
    document.getElementById('login-err').textContent = 'Cannot reach server';
  }
}

function logout() {
  token = null;
  currentUser = null;
  localStorage.removeItem('sv_token');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('login-pass').value = '';
}

async function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');

  if (!currentUser) {
    const me = await api('/api/auth/me');
    if (!me) return;
    currentUser = me;
  }

  document.getElementById('user-name').textContent = currentUser.username;
  document.getElementById('user-avatar').textContent = currentUser.username[0].toUpperCase();

  if (currentUser.is_admin) {
    document.getElementById('admin-nav').style.display = 'flex';
  }

  await loadLibraries();
  loadHome();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Navigation
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    switchView(el.dataset.view);
  });
});

document.getElementById('search-input').addEventListener('input', debounce(doSearch, 400));

function switchView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');

  if (view === 'home') loadHome();
  else if (view === 'movies') loadMediaGrid('video', 'video-grid', 'video-count');
  else if (view === 'music') loadMediaGrid('audio', 'audio-grid', 'audio-count');
  else if (view === 'photos') loadMediaGrid('photo', 'photo-grid', 'photo-count');
  else if (view === 'history') loadHistory();
  else if (view === 'playlists') loadPlaylists();
  else if (view === 'admin') loadAdmin();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Libraries
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLibraries() {
  libraries = await api('/api/libraries') || [];
  const container = document.getElementById('sidebar-libs');
  container.innerHTML = libraries.map(lib => `
    <div class="lib-item" onclick="filterByLibrary(${lib.id}, '${lib.media_type}')">
      <div class="lib-dot"></div>
      <span>${lib.name}</span>
      <span class="lib-count">${lib.media_count}</span>
    </div>
  `).join('') || '<div style="padding:8px 20px;font-size:12px;color:var(--muted)">No libraries yet</div>';
}

async function filterByLibrary(libId, mediaType) {
  const typeMap = { video: 'movies', audio: 'music', photo: 'photos' };
  const viewName = typeMap[mediaType] || 'movies';

  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  switchView(viewName);

  const grid = document.getElementById({ video:'video-grid', audio:'audio-grid', photo:'photo-grid' }[mediaType]);
  if (!grid) return;
  grid.innerHTML = '<div class="spinner"></div>';
  const data = await api(`/api/media?library_id=${libId}&limit=200`);
  renderGrid(grid, data?.items || []);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Home
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHome() {
  const [cont, recent] = await Promise.all([
    api('/api/continue-watching'),
    api('/api/media?limit=12')
  ]);
  renderContinue(cont || []);
  renderGrid(document.getElementById('recent-grid'), recent?.items || []);
}

function renderContinue(items) {
  const row = document.getElementById('continue-row');
  if (!items.length) {
    row.innerHTML = '<div class="empty"><div class="empty-sub">Nothing in progress yet</div></div>';
    return;
  }
  row.innerHTML = items.map(item => {
    const pct = item.duration ? (item.position / item.duration * 100).toFixed(1) : 0;
    const remaining = item.duration ? fmtTime(item.duration - item.position) + ' left' : '';
    const thumb = item.thumbnail_path ? `/api/media/${item.media_id}/thumbnail` : '';
    return `<div class="continue-card" onclick="playMedia(${item.media_id}, '${escHtml(item.title)}')">
      <div class="continue-thumb">
        ${thumb ? `<img src="${thumb}?t=${token}" onerror="this.style.display='none'" loading="lazy"/>` : ''}
        <div class="continue-prog" style="width:${pct}%"></div>
      </div>
      <div class="continue-body">
        <div class="continue-title">${escHtml(item.title || item.filename)}</div>
        <div class="continue-time">${remaining}</div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Media Grids
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMediaGrid(type, gridId, countId) {
  const grid = document.getElementById(gridId);
  grid.innerHTML = '<div class="spinner"></div>';
  const data = await api(`/api/media?media_type=${type}&limit=100`);
  const items = data?.items || [];
  document.getElementById(countId).textContent = items.length + ' items';
  renderGrid(grid, items);
}

function renderGrid(container, items) {
  if (!items.length) {
    container.innerHTML = `<div class="empty" style="grid-column:1/-1">
      <div class="empty-icon">â¬š</div>
      <div class="empty-text">No media found</div>
      <div class="empty-sub">Add a library in the Admin panel to get started</div>
    </div>`;
    return;
  }

  container.innerHTML = items.map(item => {
    const thumb = item.thumbnail_path ? `/api/media/${item.media_id || item.id}/thumbnail` : '';
    const icon = item.media_type === 'audio' ? 'â™ª' : item.media_type === 'photo' ? 'â—»' : 'â–¶';
    const dur = item.duration ? fmtTime(item.duration) : '';
    const mid = item.media_id || item.id;
    return `<div class="media-card" onclick="playMedia(${mid}, '${escHtml(item.title || item.filename)}')">
      <div class="card-thumb">
        ${thumb ? `<img src="${thumb}?t=${token}" onerror="this.parentNode.innerHTML='<div class=card-thumb-placeholder>${icon}</div>'" loading="lazy"/>` : `<div class="card-thumb-placeholder">${icon}</div>`}
        ${dur ? `<div class="card-badge">${dur}</div>` : ''}
        <div class="card-play-btn"><div class="play-circle">â–¶</div></div>
      </div>
      <div class="card-body">
        <div class="card-title">${escHtml(item.title || item.filename)}</div>
        <div class="card-meta">${fmtSize(item.size)}</div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Search
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSearch(query) {
  if (!query.trim()) { loadHome(); switchView('home'); return; }
  const data = await api(`/api/media?search=${encodeURIComponent(query)}&limit=100`);
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-home').classList.add('active');
  document.getElementById('view-home').innerHTML = `
    <div class="section-header">
      <span class="section-title">Results for "${escHtml(query)}"</span>
      <span class="section-count">${data?.total || 0} found</span>
    </div>
    <div class="media-grid" id="search-grid"></div>
  `;
  renderGrid(document.getElementById('search-grid'), data?.items || []);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// History
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  const data = await api('/api/history');
  renderGrid(document.getElementById('history-grid'), data || []);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Playlists
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlaylists() {
  const playlists = await api('/api/playlists') || [];
  const container = document.getElementById('playlists-container');
  if (!playlists.length) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">â‰¡</div><div class="empty-text">No playlists yet</div></div>';
    return;
  }
  container.innerHTML = playlists.map(p => `
    <div class="admin-card">
      <h3>ğŸ“‹ ${escHtml(p.name)}</h3>
      <div class="media-grid" id="pl-${p.id}"></div>
    </div>
  `).join('');

  for (const p of playlists) {
    const items = await api(`/api/playlists/${p.id}/items`) || [];
    renderGrid(document.getElementById(`pl-${p.id}`), items);
  }
}

async function createPlaylist() {
  const name = document.getElementById('new-playlist-name').value.trim();
  if (!name) return;
  await api('/api/playlists', { method:'POST', body: JSON.stringify({name}) });
  document.getElementById('new-playlist-name').value = '';
  toast('Playlist created');
  loadPlaylists();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Admin
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAdmin() {
  const libs = await api('/api/libraries') || [];
  const tbody = document.getElementById('libs-tbody');
  tbody.innerHTML = libs.map(lib => `
    <tr>
      <td>${escHtml(lib.name)}</td>
      <td style="color:var(--muted);font-size:12px">${escHtml(lib.path)}</td>
      <td><span class="badge ${lib.media_type}">${lib.media_type}</span></td>
      <td>${lib.media_count}</td>
      <td style="display:flex;gap:6px">
        <button class="btn-sm ghost" onclick="scanLib(${lib.id})">â†» Scan</button>
        <button class="btn-sm danger" onclick="deleteLib(${lib.id})">âœ•</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="color:var(--muted);text-align:center;padding:20px">No libraries yet</td></tr>';
}

async function addLibrary() {
  const name = document.getElementById('lib-name').value.trim();
  const path = document.getElementById('lib-path').value.trim();
  const type = document.getElementById('lib-type').value;
  if (!name || !path) { toast('Fill in all fields'); return; }

  const res = await api('/api/libraries', { method:'POST', body: JSON.stringify({name, path, media_type: type}) });
  if (res) {
    toast('Library added! Scanning in backgroundâ€¦');
    document.getElementById('lib-name').value = '';
    document.getElementById('lib-path').value = '';
    await loadLibraries();
    loadAdmin();
  }
}

async function scanLib(id) {
  await api(`/api/libraries/${id}/scan`, { method:'POST' });
  toast('Scan startedâ€¦');
  setTimeout(() => { loadLibraries(); loadAdmin(); }, 2000);
}

async function deleteLib(id) {
  if (!confirm('Delete this library and all its media records?')) return;
  await api(`/api/libraries/${id}`, { method:'DELETE' });
  toast('Library deleted');
  await loadLibraries();
  loadAdmin();
}

async function createUser() {
  const username = document.getElementById('new-username').value.trim();
  const password = document.getElementById('new-password').value;
  if (!username || !password) { toast('Fill in all fields'); return; }
  const res = await api('/api/auth/register', { method:'POST', body: JSON.stringify({username, password}) });
  if (res) {
    toast(`User "${username}" created`);
    document.getElementById('new-username').value = '';
    document.getElementById('new-password').value = '';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Player
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const videoEl = document.getElementById('video-el');
const overlay = document.getElementById('player-overlay');
const seekFill = document.getElementById('seek-fill');
const seekThumb = document.getElementById('seek-thumb');
const seekWrap = document.getElementById('seek-wrap');
const timeDisp = document.getElementById('time-display');
const ppBtn = document.getElementById('play-pause-btn');
const volSlider = document.getElementById('vol-slider');
const qualitySelect = document.getElementById('quality-select');

async function playMedia(mediaId, title) {
  currentMediaId = mediaId;
  const item = await api(`/api/media/${mediaId}`);
  if (!item) return;

  document.getElementById('player-title').textContent = title;
  overlay.classList.add('visible');
  document.body.style.overflow = 'hidden';

  // Get resume position
  const history = await api('/api/history') || [];
  const prev = history.find(h => h.media_id === mediaId);
  const startAt = prev && !prev.completed ? prev.position : 0;

  const quality = qualitySelect.value;
  if (quality === 'direct') {
    videoEl.src = `/api/media/${mediaId}/stream?token=${token}`;
  } else {
    videoEl.src = `/api/media/${mediaId}/transcode?quality=${quality}&token=${token}`;
  }

  videoEl.addEventListener('loadedmetadata', () => {
    if (startAt > 10) videoEl.currentTime = startAt;
  }, { once: true });

  videoEl.play().catch(() => {});

  // Progress saving
  if (progressTimer) clearInterval(progressTimer);
  progressTimer = setInterval(saveProgress, 10000);

  showControls();
}

document.getElementById('player-close').addEventListener('click', () => {
  saveProgress();
  videoEl.pause();
  videoEl.src = '';
  overlay.classList.remove('visible');
  document.body.style.overflow = '';
  if (progressTimer) clearInterval(progressTimer);
  currentMediaId = null;
});

document.getElementById('play-pause-btn').addEventListener('click', () => {
  if (videoEl.paused) videoEl.play();
  else videoEl.pause();
  showControls();
});

document.getElementById('skip-back-btn').addEventListener('click', () => {
  videoEl.currentTime = Math.max(0, videoEl.currentTime - 10);
  showControls();
});

document.getElementById('skip-fwd-btn').addEventListener('click', () => {
  videoEl.currentTime = Math.min(videoEl.duration || 0, videoEl.currentTime + 10);
  showControls();
});

videoEl.addEventListener('play',  () => { ppBtn.textContent = 'â¸'; });
videoEl.addEventListener('pause', () => { ppBtn.textContent = 'â–¶'; });

videoEl.addEventListener('timeupdate', () => {
  const pct = videoEl.duration ? (videoEl.currentTime / videoEl.duration * 100) : 0;
  seekFill.style.width = pct + '%';
  seekThumb.style.left = pct + '%';
  timeDisp.textContent = `${fmtTime(videoEl.currentTime)} / ${fmtTime(videoEl.duration)}`;
});

seekWrap.addEventListener('click', e => {
  const rect = seekWrap.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  videoEl.currentTime = pct * (videoEl.duration || 0);
  showControls();
});

volSlider.addEventListener('input', () => {
  videoEl.volume = volSlider.value;
});

qualitySelect.addEventListener('change', () => {
  const t = videoEl.currentTime;
  playMedia(currentMediaId, document.getElementById('player-title').textContent);
  videoEl.addEventListener('loadedmetadata', () => { videoEl.currentTime = t; }, { once: true });
});

document.getElementById('fullscreen-btn').addEventListener('click', () => {
  if (!document.fullscreenElement) overlay.requestFullscreen();
  else document.exitFullscreen();
});

overlay.addEventListener('mousemove', showControls);
overlay.addEventListener('click', e => {
  if (e.target === videoEl) { if (videoEl.paused) videoEl.play(); else videoEl.pause(); showControls(); }
});

function showControls() {
  document.getElementById('player-controls').style.opacity = '1';
  document.getElementById('player-top').style.opacity = '1';
  if (controlsTimeout) clearTimeout(controlsTimeout);
  controlsTimeout = setTimeout(() => {
    if (!videoEl.paused) {
      document.getElementById('player-controls').style.opacity = '0';
      const top = overlay.querySelector('.player-top');
      if (top) top.style.opacity = '0';
    }
  }, 3000);
}

document.getElementById('player-controls').style.transition = 'opacity 0.5s';

async function saveProgress() {
  if (!currentMediaId || !videoEl.duration) return;
  const position = videoEl.currentTime;
  const completed = position > videoEl.duration * 0.95;
  await api(`/api/media/${currentMediaId}/progress`, {
    method: 'POST',
    body: JSON.stringify({ position, completed })
  });
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (!overlay.classList.contains('visible')) return;
  if (e.key === 'Escape') document.getElementById('player-close').click();
  if (e.key === ' ') { e.preventDefault(); ppBtn.click(); }
  if (e.key === 'ArrowLeft') document.getElementById('skip-back-btn').click();
  if (e.key === 'ArrowRight') document.getElementById('skip-fwd-btn').click();
  if (e.key === 'f') document.getElementById('fullscreen-btn').click();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function debounce(fn, delay) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), delay);
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (token) {
  showApp();
}
</script>
</body>
</html>
